name: Test Problem-List

on:
  pull_request:
  workflow_call:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v6

      - name: Install Dependencies
        run: npm install

      - name: Test problems solutions
        run: npm run test:ci

      - name: Add summary
        if: always()
        run: |
          echo "# ðŸ§¾ Workflow Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Status:** \`${{ job.status }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "---" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          echo "# ðŸ§ª Test Summary (Vitest)" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if [ ! -f ./vitest-report.json ]; then
            echo "> [!WARNING]" >> "$GITHUB_STEP_SUMMARY"
            echo "> No test summary found (`vitest-report.json` is missing)." >> "$GITHUB_STEP_SUMMARY"
            exit
          fi

          # Keep your exact values (no logic change), but use -r so they render nicely (no JSON quotes)
          total=$(jq -r '.numTotalTests' vitest-report.json)
          succeed=$(jq -r '.numPassedTests' vitest-report.json)
          failed=$(jq -r '.numFailedTests' vitest-report.json)
          passed=$(jq -r '.success' vitest-report.json)
          seconds=$(( ( $(date +%s) * 1000 - $(jq -r '.startTime' vitest-report.json) ) / 1000 ))

          # A compact table looks much nicer than plain lines
          echo "| Metric | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|---|---:|" >> "$GITHUB_STEP_SUMMARY"
          echo "| âœ… Passed | **$succeed** |" >> "$GITHUB_STEP_SUMMARY"
          echo "| âŒ Failed | **$failed** |" >> "$GITHUB_STEP_SUMMARY"
          echo "| ðŸ§® Total | **$total** |" >> "$GITHUB_STEP_SUMMARY"
          echo "| â±ï¸ Duration | **${seconds}s** |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          # This is your "passed" logic, just displayed prettier.
          if [ "$passed" = "true" ]; then
            echo "> [!NOTE]" >> "$GITHUB_STEP_SUMMARY"
            echo "> âœ… **All tests passed.** Nice." >> "$GITHUB_STEP_SUMMARY"
          else
            echo "> [!CAUTION]" >> "$GITHUB_STEP_SUMMARY"
            echo "> âŒ **Some tests failed.** See details below." >> "$GITHUB_STEP_SUMMARY"
          fi

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "---" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          # Failed tests section
          if [ "$passed" = "false" ]; then
            echo "## âŒ Failed Tests" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"

            # Make failures collapsible so the summary stays clean
            echo "<details>" >> "$GITHUB_STEP_SUMMARY"
            echo "<summary><b>Show failing test details</b></summary>" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"

            jq -c '.testResults[]' vitest-report.json | while IFS= read -r testGroup; do
              test_group_status=$(printf '%s' "$testGroup" | jq -r '.status')

              if [ "$test_group_status" = "failed" ]; then
                name=$(printf '%s' "$testGroup" | jq -r '.name')

                # File / suite header
                echo "" >> "$GITHUB_STEP_SUMMARY"
                echo "### ðŸ§© \`$name\`" >> "$GITHUB_STEP_SUMMARY"

                printf '%s' "$testGroup" | jq -c '.assertionResults[]' | while IFS= read -r test; do
                  test_status=$(printf '%s' "$test" | jq -r '.status')
                  test_name=$(printf '%s' "$test" | jq -r '.ancestorTitles[0] // "Unknown group"')
                  test_title=$(printf '%s' "$test" | jq -r '.title // "Unknown test"')

                  if [ "$test_status" = "failed" ]; then
                    # Bullet list for readability
                    echo "- âŒ **$test_name** â€” $test_title" >> "$GITHUB_STEP_SUMMARY"
                  fi
                done
              fi
            done

            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "</details>" >> "$GITHUB_STEP_SUMMARY"
          fi