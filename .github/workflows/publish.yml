name: Publish Problem-List

on:
  schedule:
    - cron: "0 0 1 * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (with tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read version from package.json
        id: pkg
        run: |
          VERSION=$(jq -r '.version' package.json)
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Get latest CP-* tag
        id: tags
        run: |
          # List tags like CP-1, CP-2, CP-10 and sort numerically by the part after the dash.
          LATEST_TAG=$(
            git tag --list 'CP-*' \
            | sed -E 's/^CP-([0-9]+)$/\1\t&/' \
            | sort -n \
            | tail -n 1 \
            | cut -f2
          )

          echo "latest_tag=$LATEST_TAG" >> "$GITHUB_OUTPUT"

      - name: Decide if we should release
        id: decide
        run: |
          PKG_VERSION="${{ steps.pkg.outputs.version }}"
          LATEST_TAG="${{ steps.tags.outputs.latest_tag }}"

          # If no tags exist yet, LATEST_TAG will be empty -> release.
          if [ -n "$LATEST_TAG" ] && [ "$PKG_VERSION" = "$LATEST_TAG" ]; then
            echo "do_release=false" >> "$GITHUB_OUTPUT"
          else
            echo "do_release=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Build release notes from README section
        if: steps.decide.outputs.do_release == 'true'
        run: |
          START_MARKER="<!-- PROBLEMS_START -->"
          END_MARKER="<!-- PROBLEMS_END -->"

          if ! grep -q "$START_MARKER" README.md || ! grep -q "$END_MARKER" README.md; then
            echo "README markers not found. Add them or change START_MARKER/END_MARKER." >&2
            exit 1
          fi

          awk '
            $0 ~ start { inside=1; next }
            $0 ~ end   { inside=0 }
            inside { print }
          ' start="$START_MARKER" end="$END_MARKER" README.md > release-notes.md

          echo "# Problems in this release (${{
            steps.pkg.outputs.version
          }})" | cat - release-notes.md > tmp && mv tmp release-notes.md

      - name: Create GitHub Release (notes from README)
        if: steps.decide.outputs.do_release == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ steps.pkg.outputs.version }}"

          gh release create "$TAG" \
            --title "$TAG" \
            --notes-file release-notes.md
